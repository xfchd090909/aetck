<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二次元图片随机生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6d28d9',
                        secondary: '#4c1d95',
                        accent: '#a855f7',
                        dark: '#1e1b4b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-anime {
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
            }
            .bg-gradient-anime {
                background: linear-gradient(135deg, #2d1b69 0%, #1a0f33 100%);
            }
            .control-btn {
                @apply w-10 h-10 rounded-full flex items-center justify-center text-white bg-primary/80 hover:bg-accent transition-all duration-300 ease-in-out shadow-lg hover:shadow-accent/30 hover:scale-110 active:scale-95 backdrop-blur-sm;
            }
            .modal-enter {
                opacity: 0;
                transform: translateY(20px);
            }
            .modal-enter-active {
                opacity: 1;
                transform: translateY(0);
                transition: opacity 300ms, transform 300ms;
            }
            .modal-exit {
                opacity: 1;
            }
            .modal-exit-active {
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 300ms, transform 300ms;
            }
            .viewer-enter {
                opacity: 0;
            }
            .viewer-enter-active {
                opacity: 1;
                transition: opacity 300ms;
            }
            .viewer-exit {
                opacity: 1;
            }
            .viewer-exit-active {
                opacity: 0;
                transition: opacity 300ms;
            }
        }
    </style>
</head>
<body class="bg-gradient-anime min-h-screen overflow-hidden relative">
    <!-- 主图片背景 -->
    <div id="image-container" class="fixed inset-0 z-0 transition-opacity duration-1000 ease-in-out">
        <img id="main-image" class="w-full h-full object-cover opacity-80" alt="二次元图片">
    </div>
    
    <!-- 加载指示器 -->
    <div id="loader" class="fixed inset-0 z-40 flex items-center justify-center bg-dark/70 backdrop-blur-sm hidden">
        <div class="w-16 h-16 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
    </div>
    
    <!-- 提示消息 -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-dark/90 text-white px-6 py-3 rounded-full backdrop-blur-md shadow-lg opacity-0 transition-opacity duration-500 flex items-center gap-2">
        <i class="fa fa-info-circle text-accent"></i>
        <span id="toast-message"></span>
    </div>
    
    <!-- 图片查看器 -->
    <div id="image-viewer" class="fixed inset-0 z-30 bg-black/90 backdrop-blur-sm hidden items-center justify-center p-4">
        <button id="close-viewer" class="absolute top-4 right-4 text-white text-2xl hover:text-accent transition-colors">
            <i class="fa fa-times"></i>
        </button>
        <img id="viewer-image" class="max-w-full max-h-[90vh] object-contain shadow-2xl" alt="完整二次元图片">
    </div>
    
    <!-- API选择弹窗 -->
    <div id="api-modal-backdrop" class="fixed inset-0 z-40 bg-black/70 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="api-modal" class="fixed left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-dark/95 backdrop-blur-md rounded-xl shadow-2xl w-full max-w-md p-6 opacity-0 translate-y-8 pointer-events-none transition-all duration-300">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">选择图片来源</h3>
            <button id="close-modal" class="text-gray-400 hover:text-white transition-colors">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-3 mb-6">
            <label class="flex items-center p-3 rounded-lg bg-primary/10 hover:bg-primary/20 cursor-pointer transition-colors">
                <input type="radio" name="api" value="https://nekos.best/api/v2/neko" class="mr-3 accent-accent" checked>
                <span class="text-white">nekos.best</span>
            </label>
            <label class="flex items-center p-3 rounded-lg bg-primary/10 hover:bg-primary/20 cursor-pointer transition-colors">
                <input type="radio" name="api" value="https://api.waifu.im/search/?included_tags=waifu" class="mr-3 accent-accent">
                <span class="text-white">waifu.im</span>
            </label>
            <label class="flex items-center p-3 rounded-lg bg-primary/10 hover:bg-primary/20 cursor-pointer transition-colors">
                <input type="radio" name="api" value="https://pic.re/image" class="mr-3 accent-accent">
                <span class="text-white">pic.re</span>
            </label>
            <label class="flex items-center p-3 rounded-lg bg-primary/10 hover:bg-primary/20 cursor-pointer transition-colors">
                <input type="radio" name="api" value="https://api.nekosapi.com/v4/images/random" class="mr-3 accent-accent">
                <span class="text-white">nekosapi.com</span>
            </label>
            <label class="flex items-center p-3 rounded-lg bg-primary/10 hover:bg-primary/20 cursor-pointer transition-colors">
                <input type="radio" name="api" value="https://nekobot.xyz/api/image?type=neko" class="mr-3 accent-accent">
                <span class="text-white">nekobot.xyz</span>
            </label>
            <label class="flex items-center p-3 rounded-lg bg-primary/10 hover:bg-primary/20 cursor-pointer transition-colors">
                <input type="radio" name="api" value="https://www.loliapi.com/acg/" class="mr-3 accent-accent">
                <span class="text-white">loliapi.com</span>
            </label>
        </div>
        
        <button id="confirm-api" class="w-full py-3 bg-accent hover:bg-accent/80 text-white rounded-lg font-medium transition-colors">
            确认选择
        </button>
    </div>
    
    <!-- 控制区 - 页脚 -->
    <footer id="controls" class="fixed bottom-6 left-0 right-0 z-20 flex justify-center items-center gap-4 transition-all duration-500 ease-in-out">
        <button id="prev-btn" class="control-btn" title="上一张">
            <i class="fa fa-arrow-left"></i>
        </button>
        <button id="next-btn" class="control-btn" title="下一张">
            <i class="fa fa-arrow-right"></i>
        </button>
        <button id="view-btn" class="control-btn" title="查看完整图片">
            <i class="fa fa-search-plus"></i>
        </button>
        <button id="download-btn" class="control-btn" title="下载图片">
            <i class="fa fa-download"></i>
        </button>
        <button id="api-btn" class="control-btn" title="选择图片来源">
            <i class="fa fa-cog"></i>
        </button>
        <button id="hide-ui-btn" class="control-btn" title="隐藏/显示界面">
            <i class="fa fa-eye"></i>
        </button>
    </footer>

    <script>
        // DOM元素
        const imageContainer = document.getElementById('image-container');
        const mainImage = document.getElementById('main-image');
        const viewer = document.getElementById('image-viewer');
        const viewerImage = document.getElementById('viewer-image');
        const closeViewer = document.getElementById('close-viewer');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const viewBtn = document.getElementById('view-btn');
        const downloadBtn = document.getElementById('download-btn');
        const apiBtn = document.getElementById('api-btn');
        const hideUiBtn = document.getElementById('hide-ui-btn');
        const controls = document.getElementById('controls');
        const apiModal = document.getElementById('api-modal');
        const apiModalBackdrop = document.getElementById('api-modal-backdrop');
        const closeModal = document.getElementById('close-modal');
        const confirmApi = document.getElementById('confirm-api');
        const loader = document.getElementById('loader');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        // API列表和状态
        const apiList = [
            'https://nekos.best/api/v2/neko',
            'https://api.waifu.im/search/?included_tags=waifu',
            'https://pic.re/image',
            'https://api.nekosapi.com/v4/images/random',
            'https://nekobot.xyz/api/image?type=neko',
            'https://www.loliapi.com/acg/'
        ];
        // CORS代理，用于解决跨域问题
        const corsProxy = 'https://corsproxy.io/?';
        let currentApiIndex = 0;
        let currentImageUrl = '';
        let imageHistory = [];
        let historyIndex = -1;
        let isLoading = false;
        let timeoutTimer = null;
        let isUiHidden = false;
        
        // 显示提示消息
        function showToast(message, duration = 3000) {
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, duration);
        }
        
        // 显示加载指示器
        function showLoader() {
            loader.classList.remove('hidden');
            loader.classList.add('flex');
            isLoading = true;
        }
        
        // 隐藏加载指示器
        function hideLoader() {
            loader.classList.remove('flex');
            loader.classList.add('hidden');
            isLoading = false;
        }
        
        // 从API获取图片URL
        async function getImageUrlFromApi(apiUrl) {
            try {
                // 对于有CORS问题的API，使用代理
                const urlToFetch = apiUrl.includes('nekosapi.com') 
                    ? `${corsProxy}${encodeURIComponent(apiUrl)}` 
                    : apiUrl;
                
                const response = await fetch(urlToFetch);
                
                // 检查响应状态
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                
                // 不同API有不同的响应格式，需要特殊处理
                if (apiUrl === 'https://nekos.best/api/v2/neko') {
                    const data = await response.json();
                    return data.results[0].url;
                } else if (apiUrl === 'https://api.waifu.im/search/?included_tags=waifu') {
                    const data = await response.json();
                    return data.images[0].url;
                } else if (apiUrl === 'https://pic.re/image') {
                    // 这个API直接返回图片
                    return apiUrl;
                } else if (apiUrl === 'https://api.nekosapi.com/v4/images/random') {
                    const data = await response.json();
                    // 检查返回数据结构是否正确
                    if (data && data.data && data.data.attributes && data.data.attributes.file) {
                        return data.data.attributes.file;
                    } else {
                        throw new Error('nekosapi.com返回的数据格式不正确');
                    }
                } else if (apiUrl === 'https://nekobot.xyz/api/image?type=neko') {
                    const data = await response.json();
                    return data.message;
                } else if (apiUrl === 'https://www.loliapi.com/acg/') {
                    const data = await response.json();
                    return data.data.url;
                }
            } catch (error) {
                console.error(`API请求错误 (${apiUrl}):`, error);
                throw error;
            }
        }
        
        // 加载图片
        async function loadImage(apiUrl = null) {
            if (isLoading) return;
            
            showLoader();
            const urlToUse = apiUrl || apiList[currentApiIndex];
            let imageUrl;
            
            // 清除之前的超时计时器
            if (timeoutTimer) {
                clearTimeout(timeoutTimer);
            }
            
            try {
                // 设置超时计时器
                timeoutTimer = setTimeout(async () => {
                    hideLoader();
                    showToast('获取图片超时，已为你更换Api以继续获取');
                    
                    // 切换到下一个API
                    currentApiIndex = (currentApiIndex + 1) % apiList.length;
                    document.querySelector(`input[value="${apiList[currentApiIndex]}"]`).checked = true;
                    
                    // 重新加载图片
                    await loadImage();
                }, 15000);
                
                // 获取图片URL
                imageUrl = await getImageUrlFromApi(urlToUse);
                
                // 清除超时计时器
                clearTimeout(timeoutTimer);
                
                // 加载图片到DOM
                const img = new Image();
                img.src = imageUrl;
                
                img.onload = () => {
                    // 淡出当前图片
                    imageContainer.style.opacity = '0';
                    
                    setTimeout(() => {
                        // 更新图片
                        mainImage.src = imageUrl;
                        mainImage.alt = '二次元图片';
                        currentImageUrl = imageUrl;
                        
                        // 淡入新图片
                        imageContainer.style.opacity = '1';
                        hideLoader();
                        
                        // 更新历史记录
                        if (historyIndex < imageHistory.length - 1) {
                            imageHistory = imageHistory.slice(0, historyIndex + 1);
                        }
                        imageHistory.push(imageUrl);
                        historyIndex = imageHistory.length - 1;
                    }, 500);
                };
                
                img.onerror = () => {
                    clearTimeout(timeoutTimer);
                    hideLoader();
                    throw new Error('图片加载失败');
                };
                
            } catch (error) {
                clearTimeout(timeoutTimer);
                hideLoader();
                showToast(`图片加载失败: ${error.message}，尝试更换来源...`);
                
                // 切换到下一个API
                currentApiIndex = (currentApiIndex + 1) % apiList.length;
                document.querySelector(`input[value="${apiList[currentApiIndex]}"]`).checked = true;
                
                // 重试
                setTimeout(loadImage, 1000);
            }
        }
        
        // 查看完整图片
        function viewFullImage() {
            if (!currentImageUrl) return;
            
            viewerImage.src = currentImageUrl;
            viewer.classList.remove('hidden');
            viewer.classList.add('flex');
            
            // 阻止背景滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭图片查看器
        function closeFullImage() {
            viewer.classList.remove('flex');
            viewer.classList.add('hidden');
            
            // 恢复背景滚动
            document.body.style.overflow = '';
        }
        
        // 下载图片
        function downloadImage() {
            if (!currentImageUrl) return;
            
            // 对于使用代理的图片，直接使用原始URL下载
            let downloadUrl = currentImageUrl;
            if (downloadUrl.includes(corsProxy)) {
                downloadUrl = decodeURIComponent(downloadUrl.replace(corsProxy, ''));
            }
            
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `anime-image-${new Date().getTime()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('图片下载中...');
        }
        
        // 显示API选择弹窗
        function showApiModal() {
            apiModalBackdrop.classList.remove('opacity-0', 'pointer-events-none');
            apiModalBackdrop.classList.add('opacity-100', 'pointer-events-auto');
            
            apiModal.classList.remove('opacity-0', 'translate-y-8', 'pointer-events-none');
            apiModal.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
        }
        
        // 隐藏API选择弹窗
        function hideApiModal() {
            apiModalBackdrop.classList.remove('opacity-100', 'pointer-events-auto');
            apiModalBackdrop.classList.add('opacity-0', 'pointer-events-none');
            
            apiModal.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
            apiModal.classList.add('opacity-0', 'translate-y-8', 'pointer-events-none');
        }
        
        // 确认选择API
        function confirmApiSelection() {
            const selectedApi = document.querySelector('input[name="api"]:checked').value;
            currentApiIndex = apiList.indexOf(selectedApi);
            hideApiModal();
            loadImage(selectedApi);
            showToast('已切换图片来源');
        }
        
        // 上一张图片
        function prevImage() {
            if (historyIndex > 0) {
                historyIndex--;
                currentImageUrl = imageHistory[historyIndex];
                
                // 淡出当前图片
                imageContainer.style.opacity = '0';
                
                setTimeout(() => {
                    // 更新图片
                    mainImage.src = currentImageUrl;
                    
                    // 淡入新图片
                    imageContainer.style.opacity = '1';
                }, 500);
            } else {
                showToast('已经是第一张图片了');
            }
        }
        
        // 下一张图片
        function nextImage() {
            if (historyIndex < imageHistory.length - 1) {
                historyIndex++;
                currentImageUrl = imageHistory[historyIndex];
                
                // 淡出当前图片
                imageContainer.style.opacity = '0';
                
                setTimeout(() => {
                    // 更新图片
                    mainImage.src = currentImageUrl;
                    
                    // 淡入新图片
                    imageContainer.style.opacity = '1';
                }, 500);
            } else {
                loadImage();
            }
        }
        
        // 隐藏/显示UI
        function toggleUi() {
            isUiHidden = !isUiHidden;
            
            if (isUiHidden) {
                controls.style.transform = 'translateY(200px)';
                controls.style.opacity = '0';
                hideUiBtn.innerHTML = '<i class="fa fa-eye-slash"></i>';
                showToast('UI已隐藏，点击任意位置显示');
                
                // 添加临时点击事件显示UI
                const showUiOnClick = () => {
                    toggleUi();
                    document.removeEventListener('click', showUiOnClick);
                };
                
                setTimeout(() => {
                    document.addEventListener('click', showUiOnClick);
                }, 500);
            } else {
                controls.style.transform = 'translateY(0)';
                controls.style.opacity = '1';
                hideUiBtn.innerHTML = '<i class="fa fa-eye"></i>';
            }
        }
        
        // 事件监听
        nextBtn.addEventListener('click', nextImage);
        prevBtn.addEventListener('click', prevImage);
        viewBtn.addEventListener('click', viewFullImage);
        closeViewer.addEventListener('click', closeFullImage);
        downloadBtn.addEventListener('click', downloadImage);
        apiBtn.addEventListener('click', showApiModal);
        closeModal.addEventListener('click', hideApiModal);
        confirmApi.addEventListener('click', confirmApiSelection);
        hideUiBtn.addEventListener('click', toggleUi);
        
        // 点击查看器背景关闭查看器
        viewer.addEventListener('click', (e) => {
            if (e.target === viewer) {
                closeFullImage();
            }
        });
        
        // 点击弹窗背景关闭弹窗
        apiModalBackdrop.addEventListener('click', (e) => {
            if (e.target === apiModalBackdrop) {
                hideApiModal();
            }
        });
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') {
                nextImage();
            } else if (e.key === 'ArrowLeft') {
                prevImage();
            } else if (e.key === 'd' || e.key === 'D') {
                downloadImage();
            } else if (e.key === 'v' || e.key === 'V') {
                viewFullImage();
            } else if (e.key === 'Escape') {
                closeFullImage();
                hideApiModal();
            }
        });
        
        // 初始化加载图片
        loadImage();
    </script>
</body>
</html>
