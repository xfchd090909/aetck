<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anosu 图片代理调用工具</title>
  <style>
    /* 保留原有样式 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .params { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .param-group { margin-bottom: 15px; }
    label { display: inline-block; width: 100px; font-weight: bold; }
    input, select { padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 4px; }
    button { padding: 10px 20px; background: #007cf0; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #005fc4; }
    .image-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
    .image-item { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .image-item img { width: 100%; height: 250px; object-fit: cover; }
    .error { color: #e53935; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Anosu 图片代理调用工具</h1>

  <div class="params">
    <!-- 保留原有参数输入区域 -->
    <div class="param-group">
      <label for="num">图片数量：</label>
      <input type="number" id="num" min="1" max="30" value="5">
    </div>
    <div class="param-group">
      <label for="r18">年龄分级：</label>
      <select id="r18">
        <option value="0">全年龄</option>
        <option value="1">18+</option>
        <option value="2">随机</option>
      </select>
    </div>
    <div class="param-group">
      <label for="size">图片尺寸：</label>
      <select id="size">
        <option value="original">原图</option>
        <option value="regular">详情页缩略图</option>
        <option value="small">首页缩略图</option>
      </select>
    </div>
    <div class="param-group">
      <label for="keyword">关键词：</label>
      <input type="text" id="keyword" placeholder="多关键词用 | 分隔">
    </div>
    <div class="param-group">
      <label for="db">图库选择：</label>
      <select id="db">
        <option value="0">新图库</option>
        <option value="1">旧图库</option>
      </select>
    </div>
    <button onclick="fetchImages()">获取图片</button>
    <div id="error" class="error"></div>
  </div>

  <div class="image-container" id="imageContainer"></div>

  <script>
    // 1. 配置Workers接口路径（用于调用Anosu接口）
    const ANOSU_API = 'https://aenews.dpdns.org/anosu-api'; 
    // 2. 配置Workers图片代理路径（用于加载图片）
    const IMAGE_PROXY = 'https://aenews.dpdns.org/proxy-img'; 

    async function fetchImages() {
      const imageContainer = document.getElementById('imageContainer');
      const errorEl = document.getElementById('error');
      imageContainer.innerHTML = '';
      errorEl.textContent = '';

      // 构建请求参数
      const params = new URLSearchParams({
        num: document.getElementById('num').value,
        r18: document.getElementById('r18').value,
        size: document.getElementById('size').value,
        keyword: document.getElementById('keyword').value || '',
        db: document.getElementById('db').value,
        // 传递图片代理地址给Anosu接口（确保格式正确）
        proxy: IMAGE_PROXY.replace('https://', '') // 按Anosu要求去掉协议
      });

      try {
        // 调用Workers转发的Anosu接口
        const response = await fetch(`${ANOSU_API}?${params.toString()}`, {
          method: 'GET',
          headers: { 'Accept': 'application/json' } // 明确要求JSON响应
        });

        // 处理HTTP错误状态
        if (!response.ok) {
          const errorData = await response.json().catch(() => null);
          throw new Error(`接口错误: ${errorData?.error || response.statusText}`);
        }

        // 解析JSON数据（此时应返回图片URL数组）
        const imageUrls = await response.json();

        // 验证返回格式是否正确
        if (!Array.isArray(imageUrls) || imageUrls.length === 0) {
          throw new Error('未获取到图片URL列表，请检查参数');
        }

        // 渲染图片（URL已通过Workers代理）
        imageUrls.forEach(imgUrl => {
          const imgItem = document.createElement('div');
          imgItem.className = 'image-item';
          // 确保图片URL正确指向Workers代理
          imgItem.innerHTML = `<img src="${imgUrl}" alt="Anosu图片" 
            onerror="this.src='https://picsum.photos/200/250?grayscale'">`; // 错误占位图
          imageContainer.appendChild(imgItem);
        });

      } catch (err) {
        // 显示错误信息（区分JSON解析错误）
        if (err.message.includes('Unexpected token')) {
          errorEl.textContent = '错误：接口返回非JSON数据（可能路径配置错误）';
        } else {
          errorEl.textContent = `错误：${err.message}`;
        }
      }
    }
  </script>
</body>
</html>
